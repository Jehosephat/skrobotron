<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-4">
  <div id="app"></div>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    function Control() {
      const params = new URLSearchParams(window.location.search);
      const sessionId = params.get('sessionId');
      const [state, setState] = React.useState({ home: 0, away: 0, timer: 0, running: false });
      const [initialTimer, setInitialTimer] = React.useState(0);
      const socketRef = React.useRef(null);

      React.useEffect(() => {
        const socket = io({ query: { sessionId } });
        socketRef.current = socket;
        socket.on('state', (s) => {
          setState(s);
          setInitialTimer((t) => t || s.timer);
        });
        return () => socket.disconnect();
      }, [sessionId]);

      React.useEffect(() => {
        let interval;
        if (state.running) {
          interval = setInterval(() => {
            socketRef.current.emit('tick');
          }, 1000);
        }
        return () => clearInterval(interval);
      }, [state.running]);

      const updateScore = (team, delta) => {
        socketRef.current.emit('update', { [team]: state[team] + delta });
      };
      const startPause = () => socketRef.current.emit('update', { running: !state.running });
      const resetTimer = () => socketRef.current.emit('update', { timer: initialTimer, running: false });
      const formatTime = (sec) => `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;

      return (
        <div className="space-y-4">
          <div className="text-4xl">{formatTime(state.timer)}</div>
          <div className="space-x-2">
            <button className="bg-green-500 text-white px-3 py-1" onClick={startPause}>{state.running ? 'Pause' : 'Start'}</button>
            <button className="bg-gray-500 text-white px-3 py-1" onClick={resetTimer}>Reset</button>
          </div>
          <div className="flex space-x-8 text-3xl">
            <div>
              <div>Home: {state.home}</div>
              <div className="space-x-2">
                <button className="bg-blue-500 text-white px-2" onClick={() => updateScore('home', 1)}>+1</button>
                <button className="bg-blue-500 text-white px-2" onClick={() => updateScore('home', -1)}>-1</button>
              </div>
            </div>
            <div>
              <div>Away: {state.away}</div>
              <div className="space-x-2">
                <button className="bg-red-500 text-white px-2" onClick={() => updateScore('away', 1)}>+1</button>
                <button className="bg-red-500 text-white px-2" onClick={() => updateScore('away', -1)}>-1</button>
              </div>
            </div>
          </div>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('app'));
    root.render(<Control />);
  </script>
</body>
</html>
